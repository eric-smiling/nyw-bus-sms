<html>
  <head>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
      }
      .modal {
        z-index: 2000;
      }
      .sms-popover {
        position: absolute;
        max-width: 338px;
      }
      .sms-popover-entrance {
        top: 28px;
        left: 315px;
      }
      .sms-popover-terminal {
        top: 553px;
        left: 317px;
      }      
      .sms-popover.started >.arrow {
        margin-top: -70px;
      }
      .loader {
        font-size: .75em;
        text-align: center;
      }
      .loader-icon {
        height: 40px;
        width: 40px;
        display: block;
        margin: 20px auto;
        background-image: url('https://www.primeagent.com/Content/images/ajax-loader.gif');
        background-size: contain;
        background-repeat: no-repeat;
      }
      .sms-popover.started .btn-start,
      .btn-stop {
        display: none;
      }
      .sms-popover.started .btn-stop {
        display: block;
      }
    </style>
    
    <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  </head>
  <body>
    <div class="sms-popover-entrance sms-popover popover left show">
      <div class="arrow"></div>
      <h3 class="popover-title">SMS me each time the bus reaches this point</h3>
      <div class="popover-content">
        <form method="POST" action="/vehicles/entrance">
          <input required type="tel" name="to" pattern="\d{10}" class="form-control" placeholder="SMS/Mobile Number" />
          <h5><em>Format: 9175551212</em></h5>
          
          <input type="submit" class="btn-start btn btn-primary form-control" value="START" />
          <input type="button" class="btn-stop btn btn-warning form-control" value="STOP" onClick="javascript:window.location.reload();" />
          
          <div class="loader" style="display: none;">
            <div>
              <strong>Each time</strong> the bus arrives, you will recieve one text message. <br />
              You can stop the text messages yourself or the text messages will stop automatically after 3 complete bus trips.
            </div>
            <div class="loader-icon"></div>
          </div>
        </form>
      </div>
    </div>
    <!--
    <div class="sms-popover-terminal sms-popover popover right show">
      <div class="arrow"></div>
      <h3 class="popover-title">SMS me each time the bus reaches this point</h3>
      <div class="popover-content">
        <form method="POST" action="/vehicles/terminal">
          <input required type="tel" name="to" pattern="\d{10}" class="form-control" placeholder="SMS/Mobile Number" />
          <h5><em>Format: 9175551212</em></h5>
          
          <input type="submit" class="btn-start btn btn-primary form-control" value="START" />
          <input type="button" class="btn-stop btn btn-warning form-control" value="STOP" onClick="javascript:window.location.reload();" />
          
          <div class="loader" style="display: none;">
            <div>
              <strong>Each time</strong> the bus arrives, you will recieve one text message. <br />
              You can stop the text messages yourself or the text messages will stop automatically after 3 complete bus trips.
            </div>
            <div class="loader-icon"></div>
          </div>
        </form>
      </div>
    </div>
    -->
    <div id="confirmation-modal" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title">SMS Sent</h4>
          </div>
          <div class="modal-body">
            <p>The bus arrived.</p>
          </div>
          <div class="modal-footer">
          </div>
        </div><!-- /.modal-content -->
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
    <iframe
      src="http://tds1.saucontech.com/tds-map/nyw/routemapc.htm?id=52"
      width="1200"
      height="1200"
      frameborder="0"
      scrolling="no"
    ></iframe>
    <script>
      // TODO: test max f(x)
      // TODO: add more ranges
      // TODO: modify map
      // TODO: separate interval from form in code
      
      (function($){
        $(document.body).on('submit', '.sms-popover form', function(evt) {
          var $form = $(evt.target);
          var $btn = $($form.find('input[type=submit]'));
          var interval = {
            id: null,
            sms_max: 3,
            sms_count: 0,
            frequency: 5000,
            pause_length: 120000,
            start: function(){
              var self = this;
              
              if(this.sms_count >= this.sms_max) {
                return;
              }
              
              self.id = setInterval(function(){
                $.ajax({
                  type:  $form.attr('method'),
                  url: $form.attr('action'),
                  data: $form.serialize(),
                  success: function(response) {
                    if(response.vehicles && response.sms_sent) {
                      self.sms_count++;
                      self.stop();
                      self.schedule();
                    }
                    else if(response.message) {
                      alert(response.message);
                    }
                    console.log(response);
                  }
                });
              }, self.frequency);
              self.onStart();
            },
            stop: function() {
              clearTimeout(this.id);
              this.onStop();
            },
            schedule: function() {
              setTimeout((function(){
                this.start();
              }).bind(this), this.pause_length);
            },
            // ui stuff.. move / use pub sub
            onStop: function() {
              $('#confirmation-modal').modal();
            },
            onStart: function() {
              // make it stoppable
              $form.closest('.sms-popover').addClass('started');
              $form.find('.loader').show();
            }
          };
          
          // stop the form submission
          evt.preventDefault();
          
          // start the interval
          interval.start();
        }); 
      })(window.jQuery);
    </script>
  </body>
</html>